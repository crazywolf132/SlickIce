!function(a,b){"use strict";function c(a,c){var d=this;c=b.extend({breadcrumbElement:"div.ccm-search-results-breadcrumb",bulkParameterName:"fID",searchMethod:"get",selectMode:"multiple"},c),d.currentFolder=0,d.interactionIsDragging=!1,d.$breadcrumb=b(c.breadcrumbElement),d.$headerSearchInput=a.find("div[data-header=file-manager] input"),d.$advancedSearchButton=a.find("a[data-launch-dialog=advanced-search]"),d.$resetSearchButton=a.find("a[data-button-action=clear-search]"),d._templateFileProgress=_.template('<div id="ccm-file-upload-progress" class="ccm-ui"><div id="ccm-file-upload-progress-bar"><div class="progress progress-striped active"><div class="progress-bar" style="width: <%=progress%>%;"></div></div></div></div>'),ConcreteAjaxSearch.call(d,a,c),ConcreteTree.setupTreeEvents(),d.setupEvents(),d.setupAddFolder(),d.setupFileUploads(),d.setupFileDownloads()}c.prototype=Object.create(ConcreteAjaxSearch.prototype),c.prototype.setupAdvancedSearch=function(){var a=this;a.$advancedSearchButton.on("click",function(){var c=b(this).attr("href");return b.fn.dialog.open({width:620,height:500,href:c,modal:!0,title:ccmi18n.search,onOpen:function(){a.setupAdvancedSearchDialog()}}),!1})},c.prototype.setupRowDragging=function(){var a=this,c=a.$element.find("tr[data-file-manager-tree-node-type!=file_folder]");a.$element.find("tr[data-file-manager-tree-node-type]").each(function(){var d,e=b(this);switch(b(this).attr("data-file-manager-tree-node-type")){case"file_folder":d="ccm-search-results-folder";break;case"file":d="ccm-search-results-file"}d&&e.draggable({delay:300,start:function(d){a.interactionIsDragging=!0,c.css("opacity","0.4"),d.altKey&&a.$element.addClass("ccm-search-results-copy"),a.$element.find(".ccm-search-select-hover").removeClass("ccm-search-select-hover"),b(window).on("keydown.concreteSearchResultsCopy",function(b){18==b.keyCode?a.$element.addClass("ccm-search-results-copy"):a.$element.removeClass("ccm-search-results-copy")}),b(window).on("keyup.concreteSearchResultsCopy",function(b){18==b.keyCode&&a.$element.removeClass("ccm-search-results-copy")})},stop:function(){b(window).unbind(".concreteSearchResultsCopy"),c.css("opacity",""),a.$element.removeClass("ccm-search-results-copy"),a.interactionIsDragging=!1},revert:"invalid",helper:function(){var c=a.$element.find(".ccm-search-select-selected");return b('<div class="'+d+' ccm-draggable-search-item"><span>'+c.length+"</span></div>").data("$selected",c)},cursorAt:{left:-20,top:5}})}),a.$element.find("tr[data-file-manager-tree-node-type=file_folder], ol[data-search-navigation=breadcrumb] a[data-file-manager-tree-node]").droppable({hoverClass:"ccm-search-select-active-droppable",drop:function(c,d){var e=d.helper.data("$selected"),f=[],g=b(this).data("file-manager-tree-node"),h=c.altKey;e.each(function(){var a=b(this),c=a.data("file-manager-tree-node");c==g?e=e.not(this):f.push(b(this).data("file-manager-tree-node"))}),0!==f.length&&(h||e.hide(),new ConcreteAjaxRequest({url:CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/drag_request",data:{ccm_token:a.options.upload_token,copyNodes:h?"1":0,sourceTreeNodeIDs:f,treeNodeParentID:g},success:function(a){h||e.remove(),ConcreteAlert.notify({message:a.message,title:a.title})},error:function(a){e.show();var b=a.responseText;a.responseJSON&&a.responseJSON.errors&&(b=a.responseJSON.errors.join("<br/>")),ConcreteAlert.dialog(ccmi18n.error,b)}}))}})},c.prototype.setupAdvancedSearchDialog=function(){var a=this,c=b("div[data-container=search-fields]"),d=_.template(b("script[data-template=search-field-row]").html()),e=b("script[data-template=default-query]").html();e&&(e=JSON.parse(e)),b("button[data-button-action=add-field]").on("click",function(){c.append(d())}),a.result.query?b.each(a.result.query.fields,function(a,b){c.append(d({field:b}))}):e&&b.each(e.fields,function(a,b){c.append(d({field:b}))}),c.find("select.selectize-select").selectize(),c.on("change","select.ccm-search-choose-field",function(){var a=b(this).val(),c=b(this).parent().find("div.ccm-search-field-content");a&&b.concreteAjax({url:b(this).attr("data-action"),data:{field:a},success:function(a){c.html(a.element),c.find("select.selectize-select").selectize()}})}),c.on("click","a[data-search-remove=search-field]",function(a){a.preventDefault();var c=b(this).parent();c.remove()}),b("button[data-button-action=save-search-preset]").on("click.saveSearchPreset",function(){jQuery.fn.dialog.open({element:"div[data-dialog=save-search-preset]:first",modal:!0,width:320,title:"Save Preset",height:"auto"})});var f=b("form[data-form=save-preset]"),g=b("form[data-advanced-search-form]");b("button[data-button-action=save-search-preset-submit]").on("click.saveSearchPresetSubmit",function(){var a=b("form[data-form=save-preset]");a.trigger("submit")}),f.on("submit",function(){var a=g.serializeArray();return a=a.concat(f.serializeArray()),b.concreteAjax({data:a,url:f.attr("action"),success:function(a){jQuery.fn.dialog.closeAll(),ConcreteEvent.publish("SavedSearchCreated",{search:a})}}),!1}),a.setupSearch()},c.prototype.setupBreadcrumb=function(a){var c=this,d=c.$element.closest("div.ui-dialog").find(".ui-dialog-titlebar");if(d.length&&c.$breadcrumb.appendTo(d),a.breadcrumb){c.$breadcrumb.html("");var e=b('<ol data-search-navigation="breadcrumb" class="breadcrumb" />');b.each(a.breadcrumb,function(a,d){var f="";d.active&&(f=' class="active"'),e.append("<li"+f+'><a data-file-manager-tree-node="'+d.folder+'" href="'+d.url+'">'+d.name+"</a></li>"),e.find("li.active a").on("click",function(a){if(a.stopPropagation(),a.preventDefault(),d.menu){var f=b(d.menu);c.showMenu(e,f,a)}})}),e.appendTo(c.$breadcrumb),e.on("click.concreteSearchBreadcrumb","a",function(){return c.loadFolder(b(this).attr("data-file-manager-tree-node")),!1})}},c.prototype.setupFileDownloads=function(){var a=this;b("#ccm-file-manager-download-target").length?a.$downloadTarget=b("#ccm-file-manager-download-target"):a.$downloadTarget=b("<iframe />",{name:"ccm-file-manager-download-target",id:"ccm-file-manager-download-target"}).appendTo(document.body)},c.prototype.setupResetButton=function(a){var b=this;a.query&&(b.$headerSearchInput.prop("disabled",!0),b.$headerSearchInput.attr("placeholder",""),b.$advancedSearchButton.html(ccmi18n_filemanager.edit),b.$resetSearchButton.show())},c.prototype.setupFileUploads=function(){var a=this,c=b("#ccm-file-manager-upload"),d=c.data("image-max-width"),e=c.data("image-max-height"),f=d>0&&e>0,g=c.data("image-quality"),h=[],i=[],j=_.template("<ul><% _(errors).each(function(error) { %><li><strong><%- error.name %></strong><p><%- error.error %></p></li><% }) %></ul>"),k={url:CCM_DISPATCHER_FILENAME+"/ccm/system/file/upload",dataType:"json",disableImageResize:!f,imageQuality:g>0?g:85,imageMaxWidth:d>0?d:1920,imageMaxHeight:e>0?e:1080,error:function(a){var b=a.responseText;try{b=jQuery.parseJSON(b).errors;var c=this.files[0].name;_(b).each(function(a){h.push({name:c,error:a})})}catch(d){}},progressall:function(c,d){var e=parseInt(d.loaded/d.total*100,10);b("#ccm-file-upload-progress-wrapper").html(a._templateFileProgress({progress:e}))},start:function(){h=[],b("<div />",{id:"ccm-file-upload-progress-wrapper"}).html(a._templateFileProgress({progress:100})).appendTo(document.body),b.fn.dialog.open({title:ccmi18n_filemanager.uploadProgress,width:400,height:50,onClose:function(a){a.jqdialog("destroy").remove()},element:b("#ccm-file-upload-progress-wrapper"),modal:!0})},done:function(a,b){i.push(b.result[0])},stop:function(){if(jQuery.fn.dialog.closeTop(),h.length)ConcreteAlert.dialog(ccmi18n_filemanager.uploadFailed,j({errors:h}));else{var b=!1;_.each(i,function(a){a.canEditFileProperties&&(b=!0)}),b?a._launchUploadCompleteDialog(i):a.reloadFolder(),i=[]}}};c.fileupload(k),c.bind("fileuploadsubmit",function(b,c){c.formData={currentFolder:a.currentFolder,ccm_token:a.options.upload_token}}),b("a[data-dialog=add-files]").on("click",function(){b.fn.dialog.open({width:620,height:500,modal:!0,title:ccmi18n_filemanager.addFiles,href:CCM_DISPATCHER_FILENAME+"/tools/required/files/import?currentFolder="+a.currentFolder})})},c.prototype.refreshResults=function(a){var b=this;b.reloadFolder()},c.prototype._launchUploadCompleteDialog=function(a){var b=this;c.launchUploadCompleteDialog(a,b)},c.prototype.setupFolders=function(a){var c=this,d=c.$element.find("tbody tr");a.folder&&(c.currentFolder=a.folder.treeNodeID),c.$element.find("tbody tr").on("dblclick",function(){var a=d.index(b(this));if(a>-1){var e=c.getResult().items[a];e&&e.isFolder&&c.loadFolder(e.treeNodeID)}})},c.prototype.setupEvents=function(){var a=this;ConcreteEvent.subscribe("AjaxFormSubmitSuccess",function(b,c){"add-folder"==c.form&&a.reloadFolder()}),ConcreteEvent.unsubscribe("FileManagerAddFilesComplete"),ConcreteEvent.subscribe("FileManagerAddFilesComplete",function(b,c){a._launchUploadCompleteDialog(c.files)}),ConcreteEvent.unsubscribe("FileManagerDeleteFilesComplete"),ConcreteEvent.subscribe("FileManagerDeleteFilesComplete",function(b,c){a.reloadFolder()}),ConcreteEvent.unsubscribe("ConcreteTreeUpdateTreeNode.concreteTree"),ConcreteEvent.subscribe("ConcreteTreeUpdateTreeNode.concreteTree",function(b,c){a.reloadFolder()}),ConcreteEvent.unsubscribe("ConcreteTreeDeleteTreeNode.concreteTree"),ConcreteEvent.subscribe("ConcreteTreeDeleteTreeNode.concreteTree",function(b,c){a.reloadFolder()}),ConcreteEvent.unsubscribe("SavedSearchCreated"),ConcreteEvent.subscribe("SavedSearchCreated",function(b,c){a.ajaxUpdate(c.search.baseUrl,{})})},c.prototype.showMenu=function(a,b,c){var d=this,e=new ConcreteFileMenu(a,{menu:b,handle:"none",container:d});e.show(c)},c.prototype.activateMenu=function(a){var c=this;if(c.getSelectedResults().length>1&&a.find("a").on("click.concreteFileManagerBulkAction",function(a){var d=b(this).attr("data-bulk-action"),e=b(this).attr("data-bulk-action-type"),f=[];b.each(c.getSelectedResults(),function(a,b){f.push(b.fID)}),c.handleSelectedBulkAction(d,e,b(this),f)}),"choose"!=c.options.selectMode){var d=a.find("a[data-file-manager-action=clear]").parent();d.next("li.divider").remove(),d.remove()}},c.prototype.setupBulkActions=function(){var a=this;a.$element.on("click","button.btn-menu-launcher",function(c){var d=a.getResultMenu(a.getSelectedResults());d&&(d.find(".dialog-launch").dialog(),b(this).parent().find("ul").remove(),b(this).parent().append(d.find("ul")))})},c.prototype.handleSelectedBulkAction=function(a,c,d,e){var f=this,g=[];"choose"==a?(ConcreteEvent.publish("FileManagerBeforeSelectFile",{fID:e}),ConcreteEvent.publish("FileManagerSelectFile",{fID:e})):"download"==a?(b.each(e,function(a,b){g.push({name:"item[]",value:b})}),f.$downloadTarget.get(0).src=CCM_TOOLS_PATH+"/files/download?"+jQuery.param(g)):ConcreteAjaxSearch.prototype.handleSelectedBulkAction.call(this,a,c,d,e)},c.prototype.reloadFolder=function(){this.loadFolder(this.currentFolder)},c.prototype.setupAddFolder=function(){var a=this;a.$element.find("a[data-launch-dialog=add-file-manager-folder]").on("click",function(){b("div[data-dialog=add-file-manager-folder] input[name=currentFolder]").val(a.currentFolder),jQuery.fn.dialog.open({element:"div[data-dialog=add-file-manager-folder]",modal:!0,width:320,title:"Add Folder",height:"auto"})})},c.prototype.hoverIsEnabled=function(a){var b=this;return!b.interactionIsDragging},c.prototype.updateResults=function(a){var c=this;ConcreteAjaxSearch.prototype.updateResults.call(c,a),c.setupFolders(a),c.setupBreadcrumb(a),c.setupResetButton(a),c.setupRowDragging(),"choose"==c.options.selectMode&&(c.$element.unbind(".concreteFileManagerHoverFile"),c.$element.on("mouseover.concreteFileManagerHoverFile","tr[data-file-manager-tree-node-type]",function(){b(this).addClass("ccm-search-select-hover")}),c.$element.on("mouseout.concreteFileManagerHoverFile","tr[data-file-manager-tree-node-type]",function(){b(this).removeClass("ccm-search-select-hover")}),c.$element.unbind(".concreteFileManagerChooseFile").on("click.concreteFileManagerChooseFile","tr[data-file-manager-tree-node-type=file]",function(a){return ConcreteEvent.publish("FileManagerBeforeSelectFile",{fID:b(this).attr("data-file-manager-file")}),ConcreteEvent.publish("FileManagerSelectFile",{fID:b(this).attr("data-file-manager-file")}),c.$downloadTarget.remove(),!1}),c.$element.unbind(".concreteFileManagerOpenFolder").on("click.concreteFileManagerOpenFolder","tr[data-file-manager-tree-node-type=search_preset],tr[data-file-manager-tree-node-type=file_folder]",function(a){a.preventDefault(),c.loadFolder(b(this).attr("data-file-manager-tree-node"))}))},c.prototype.loadFolder=function(a){var b=this,c=b.getSearchData();c.push({name:"folder",value:a}),b.currentFolder=a,b.ajaxUpdate(b.options.result.baseUrl,c),b.$element.find("#ccm-file-manager-upload input[name=currentFolder]").val(b.currentFolder)},c.prototype.getResultMenu=function(a){var b=this,c=ConcreteAjaxSearch.prototype.getResultMenu.call(this,a);return c&&b.activateMenu(c),c},c.prototype.setupSearch=function(){var a=this;ConcreteAjaxSearch.prototype.setupSearch.call(this),a.$element.find("div[data-header=file-manager] form").on("submit",function(){var c=b(this).serializeArray();return c.push({name:"submitSearch",value:"1"}),a.ajaxUpdate(b(this).attr("action"),c),a.$advancedSearchButton.hide(),a.$resetSearchButton.addClass("ccm-file-manager-reset-search-right").show(),!1});var c=a.$element.closest("div.ui-dialog");c.length&&a.$element.find("div[data-header=file-manager]").appendTo(c),b("form[data-advanced-search-form]").concreteAjaxForm({success:function(b){a.updateResults(b),jQuery.fn.dialog.closeTop(),a.$advancedSearchButton.html(ccmi18n_filemanager.edit),a.$resetSearchButton.show(),a.$headerSearchInput.prop("disabled",!0).val(""),a.$headerSearchInput.attr("placeholder","")}}),a.$resetSearchButton.on("click",function(c){a.$element.find("div[data-header=file-manager] input").val(""),c.preventDefault(),b.concreteAjax({url:b(this).attr("data-button-action-url"),success:function(b){a.updateResults(b),a.$headerSearchInput.prop("disabled",!1),a.$headerSearchInput.attr("placeholder",ccmi18n.search),a.$advancedSearchButton.html(ccmi18n.advanced).show(),a.$resetSearchButton.removeClass("ccm-file-manager-reset-search-right").hide()}})})},c.launchDialog=function(a,c){var d,e=b(window).width()-53,f={},g={filters:[],multipleSelection:!1};if(b.extend(g,c),g.filters.length>0)for(f["field[]"]=[],d=0;d<g.filters.length;d++){var h=b.extend(!0,{},g.filters[d]);f["field[]"].push(h.field),delete h.field,b.extend(f,h)}b.fn.dialog.open({width:e,height:"100%",href:CCM_DISPATCHER_FILENAME+"/ccm/system/dialogs/file/search",modal:!0,data:f,title:ccmi18n_filemanager.title,onOpen:function(c){ConcreteEvent.unsubscribe("FileManagerSelectFile"),ConcreteEvent.subscribe("FileManagerSelectFile",function(c,d){var e="[object Array]"===Object.prototype.toString.call(d.fID);if(g.multipleSelection&&!e)d.fID=[d.fID];else if(!g.multipleSelection&&e){if(d.fID.length>1)return b(".ccm-search-bulk-action option:first-child").prop("selected","selected"),void alert(ccmi18n_filemanager.chosenTooMany);d.fID=d.fID[0]}jQuery.fn.dialog.closeTop(),a(d)})}})},c.getFileDetails=function(a,c){b.ajax({type:"post",dataType:"json",url:CCM_DISPATCHER_FILENAME+"/ccm/system/file/get_json",data:{fID:a},error:function(a){ConcreteAlert.dialog("Error",a.responseText)},success:function(a){c(a)}})},c.launchUploadCompleteDialog=function(a,c){if(a&&a.length&&a.length>0){var d="";_.each(a,function(a){d+="fID[]="+a.fID+"&"}),d=d.substring(0,d.length-1),b.fn.dialog.open({width:"660",height:"500",href:CCM_DISPATCHER_FILENAME+"/ccm/system/dialogs/file/upload_complete",modal:!0,data:d,onClose:function(){var a={filemanager:c};ConcreteEvent.publish("FileManagerUploadCompleteDialogClose",a)},onOpen:function(){var a={filemanager:c};ConcreteEvent.publish("FileManagerUploadCompleteDialogOpen",a)},title:ccmi18n_filemanager.uploadComplete})}},b.fn.concreteFileManager=function(a){return b.each(b(this),function(d,e){new c(b(this),a)})},a.ConcreteFileManager=c}(window,$),!function(a,b){"use strict";function c(a,c){var d=this,c=b.extend({chooseText:ccmi18n_filemanager.chooseNew,inputName:"concreteFile",fID:!1,filters:[]},c),e={};e.filters=c.filters,d.$element=a,d.options=c,d._chooseTemplate=_.template(d.chooseTemplate,{options:d.options}),d._loadingTemplate=_.template(d.loadingTemplate),d._fileLoadedTemplate=_.template(d.fileLoadedTemplate),d.$element.append(d._chooseTemplate),d.$element.on("click","div.ccm-file-selector-choose-new",function(){return ConcreteFileManager.launchDialog(function(a){d.loadFile(a.fID)},e),!1}),d.options.fID&&d.loadFile(d.options.fID)}c.prototype={chooseTemplate:'<div class="ccm-file-selector-choose-new"><input type="hidden" name="<%=options.inputName%>" value="0" /><%=options.chooseText%></div>',loadingTemplate:'<div class="ccm-file-selector-loading"><img src="'+CCM_IMAGE_PATH+'/throbber_white_16.gif" /></div>',fileLoadedTemplate:'<div class="ccm-file-selector-file-selected"><input type="hidden" name="<%=inputName%>" value="<%=file.fID%>" /><div class="ccm-file-selector-file-selected-thumbnail"><%=file.resultsThumbnailImg%></div><div class="ccm-file-selector-file-selected-title"><div><%=file.title%></div></div><div class="clearfix"></div></div>',loadFile:function(a){var c=this;c.$element.html(c._loadingTemplate),ConcreteFileManager.getFileDetails(a,function(a){var d=a.files[0];c.$element.html(c._fileLoadedTemplate({inputName:c.options.inputName,file:d})),c.$element.find(".ccm-file-selector-file-selected").on("click",function(a){var e=d.treeNodeMenu;if(e){var f=new ConcreteFileMenu(b(this),{menuLauncherHoverClass:"ccm-file-manager-menu-item-hover",menu:b(e),handle:"none",container:c});f.show(a)}})})}},b.fn.concreteFileSelector=function(a){return b.each(b(this),function(d,e){new c(b(this),a)})},a.ConcreteFileSelector=c}(this,$),!function(a,b,c){"use strict";function d(a,c){var d=this,c=c||{};c=b.extend({container:!1},c),ConcreteMenu.call(d,a,c)}d.prototype=Object.create(ConcreteMenu.prototype),d.prototype.setupMenuOptions=function(a){var d=this,e=ConcreteMenu.prototype,f=a.attr("data-search-file-menu"),g=d.options.container;e.setupMenuOptions(a),a.find("a[data-file-manager-action=clear]").on("click",function(){var a=ConcreteMenuManager.getActiveMenu();return a&&a.hide(),c.defer(function(){g.$element.html(g._chooseTemplate)}),!1}),a.find("a[data-file-manager-action=duplicate]").on("click",function(){return b.concreteAjax({url:CCM_DISPATCHER_FILENAME+"/ccm/system/file/duplicate",data:{fID:f},success:function(a){"undefined"!=typeof g.refreshResults&&g.refreshResults()}}),!1})},b.fn.concreteFileMenu=function(a){return b.each(b(this),function(c,e){new d(b(this),a)})},a.ConcreteFileMenu=d}(this,$,_);